<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Bajas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    margin:0;
    font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
    background:#f0f2f5;
    color:#333;
    padding:20px;
  }

  h1 {
    text-align:center;
    color:#dc3545;
  }

  .tabs {
    display:flex;
    justify-content:center;
    gap:10px;
    margin-bottom:20px;
  }

  .tabs button {
    padding:8px 16px;
    border:none;
    border-radius:20px;
    cursor:pointer;
    background:#dc3545;
    color:white;
    font-weight:600;
    transition:0.25s;
  }

  .tabs button.active {
    background:#a71d2a;
  }

  .tab-content {
    max-width:900px;
    margin:0 auto;
  }

  .form-group {
    margin-bottom:12px;
  }

  .form-group label {
    font-weight:600;
  }

  .form-group input, .form-group textarea {
    width:100%;
    padding:8px;
    border-radius:6px;
    border:1px solid #ccc;
    margin-top:4px;
    font-size:14px;
  }

  .form-group textarea {
    resize:vertical;
  }

  button.submit-btn {
    background:#28a745;
    color:white;
    font-weight:600;
    padding:10px 16px;
    border:none;
    border-radius:20px;
    cursor:pointer;
    transition:0.25s;
  }

  button.submit-btn:hover {
    background:#218838;
  }

  .baja-card {
    background:white;
    padding:16px 20px;
    border-radius:12px;
    margin-bottom:16px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    transition:0.2s;
  }

  .baja-card:hover {
    box-shadow:0 6px 20px rgba(0,0,0,0.15);
  }

  .baja-card p {
    margin:4px 0;
  }

  .label {
    font-weight:600;
    color:#555;
  }

  .actions {
    margin-top:8px;
    display:flex;
    gap:8px;
  }

  .actions button {
    padding:6px 12px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
    transition:0.25s;
  }

  .actions button.delete {
    background:#dc3545;
    color:white;
  }

  .actions button.note {
    background:#ffc107;
    color:white;
  }
</style>
</head>
<body>

<h1>Bajas</h1>

<div class="tabs">
  <button id="tabNuevo" class="active">Nuevo</button>
  <button id="tabRegistros">Registros</button>
</div>

<div class="tab-content" id="nuevoTab">
  <div class="form-group">
    <label>Nombre del Usuario</label>
    <input type="text" id="nombreUsuario">
  </div>
  <div class="form-group">
    <label>Motivo</label>
    <input type="text" id="motivo">
  </div>
  <div class="form-group">
    <label>Otras Observaciones</label>
    <textarea id="observaciones" rows="3"></textarea>
  </div>
  <button class="submit-btn" id="guardarBaja">Guardar Baja</button>
</div>

<div class="tab-content" id="registrosTab" style="display:none;">
  <div id="bajasContainer">
    <!-- Bajas se cargan aquí -->
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, arrayUnion, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBPr8ZmxwYLyH1j8EygyMH78_4fAyu0xFo",
    authDomain: "tsjcatrp.firebaseapp.com",
    projectId: "tsjcatrp",
    storageBucket: "tsjcatrp.firebasestorage.app",
    messagingSenderId: "858193188422",
    appId: "1:858193188422:web:3b5118e1022a44faad9c47"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;

  onAuthStateChanged(auth, (user) => {
    if(!user){
      window.location.href="/modulo_acceso/identificacion.jsp/pagina.html";
    } else {
      currentUser = user;
      loadBajas();
    }
  });

  // TAB SWITCH
  const tabNuevo = document.getElementById("tabNuevo");
  const tabRegistros = document.getElementById("tabRegistros");
  const nuevoTab = document.getElementById("nuevoTab");
  const registrosTab = document.getElementById("registrosTab");

  tabNuevo.addEventListener("click",()=>{
    tabNuevo.classList.add("active");
    tabRegistros.classList.remove("active");
    nuevoTab.style.display="block";
    registrosTab.style.display="none";
  });

  tabRegistros.addEventListener("click",()=>{
    tabRegistros.classList.add("active");
    tabNuevo.classList.remove("active");
    nuevoTab.style.display="none";
    registrosTab.style.display="block";
    loadBajas();
  });

  // GUARDAR BAJA
  document.getElementById("guardarBaja").addEventListener("click", async ()=>{
    const nombreUsuario = document.getElementById("nombreUsuario").value.trim();
    const motivo = document.getElementById("motivo").value.trim();
    const observaciones = document.getElementById("observaciones").value.trim();

    if(!nombreUsuario || !motivo) return alert("Nombre y motivo son obligatorios");

    try{
      await addDoc(collection(db,"bajas"),{
        creadorUID: currentUser.uid,
        nombreUsuario,
        motivo,
        observaciones,
        notas:[]
      });
      alert("Baja registrada");
      document.getElementById("nombreUsuario").value="";
      document.getElementById("motivo").value="";
      document.getElementById("observaciones").value="";
      loadBajas();
    }catch(err){
      console.error(err);
      alert("Error registrando baja");
    }
  });

  // CARGAR BAJAS
  async function loadBajas(){
    const container = document.getElementById("bajasContainer");
    container.innerHTML="";
    const snapshot = await getDocs(collection(db,"bajas"));

    if(snapshot.empty){
      container.innerHTML="<p>No hay bajas registradas.</p>";
      return;
    }

    snapshot.forEach(docu=>{
      const data = docu.data();

      const card = document.createElement("div");
      card.className="baja-card";
      card.innerHTML=`
        <p><span class="label">Usuario:</span> ${data.nombreUsuario}</p>
        <p><span class="label">Motivo:</span> ${data.motivo}</p>
        <p><span class="label">Observaciones:</span> ${data.observaciones}</p>
        <p><span class="label">Notas:</span> ${data.notas?.join(", ") || "-"}</p>
        <div class="actions">
          <button class="note">Añadir Nota</button>
          <button class="delete">Eliminar</button>
        </div>
      `;

      // Añadir nota
      card.querySelector(".note").addEventListener("click", async ()=>{
        const nota = prompt("Ingrese nota:");
        if(nota){
          await updateDoc(doc(db,"bajas",docu.id),{
            notas: arrayUnion(nota)
          });
          loadBajas();
        }
      });

      // Eliminar
      card.querySelector(".delete").addEventListener("click", async ()=>{
        if(confirm("Eliminar baja?")){
          await deleteDoc(doc(db,"bajas",docu.id));
          loadBajas();
        }
      });

      container.appendChild(card);
    });
  }
</script>

</body>
</html>
