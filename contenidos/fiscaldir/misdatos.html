<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mis Datos - TSJ CATRP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    margin:0;
    font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
    background:#f0f2f5;
    color:#333;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding-top:50px;
    min-height:100vh;
  }

  .card {
    background:white;
    padding:30px 40px;
    border-radius:16px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    max-width:400px;
    width:100%;
    text-align:center;
  }

  h1 {
    color:#1e90ff;
    margin-bottom:30px;
  }

  img {
    width:120px;
    height:120px;
    border-radius:50%;
    object-fit:cover;
    margin-bottom:20px;
    border:3px solid #1e90ff;
  }

  .form-group {
    margin-bottom:16px;
    text-align:left;
  }

  .form-group label {
    font-weight:600;
    display:block;
    margin-bottom:4px;
  }

  .form-group input {
    width:100%;
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:14px;
  }

  button {
    padding:10px 20px;
    border:none;
    border-radius:20px;
    background:#28a745;
    color:white;
    font-weight:600;
    cursor:pointer;
    transition:0.25s;
  }

  button:hover {
    background:#218838;
  }

</style>
</head>
<body>

<div class="card">
  <h1>Mis Datos</h1>
  <img id="fotoUsuario" src="" alt="Foto Usuario">
  <p><strong>Nombre:</strong> <span id="nombreUsuario"></span></p>
  <p><strong>Rol:</strong> <span id="roleUsuario"></span></p>

  <div class="form-group">
    <label>Cambiar Foto (URL)</label>
    <input type="text" id="nuevaFoto" placeholder="Ingresa la URL de tu foto">
  </div>

  <button id="guardarFoto">Actualizar Foto</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBPr8ZmxwYLyH1j8EygyMH78_4fAyu0xFo",
    authDomain: "tsjcatrp.firebaseapp.com",
    projectId: "tsjcatrp",
    storageBucket: "tsjcatrp.firebasestorage.app",
    messagingSenderId: "858193188422",
    appId: "1:858193188422:web:3b5118e1022a44faad9c47"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;

  onAuthStateChanged(auth, async user => {
    if(!user) {
      window.location.href="/modulo_acceso/identificacion.jsp/pagina.html";
      return;
    }
    currentUser = user;

    // Cargar datos del usuario
    const docRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const data = docSnap.data();
      document.getElementById("nombreUsuario").textContent = data.Nombre || "-";
      document.getElementById("roleUsuario").textContent = data.role || "-";
      document.getElementById("fotoUsuario").src = data.Foto || "https://via.placeholder.com/120";
    }
  });

  // Actualizar foto
  document.getElementById("guardarFoto").addEventListener("click", async ()=>{
    const url = document.getElementById("nuevaFoto").value.trim();
    if(!url) return alert("Ingrese una URL v√°lida");

    try{
      await updateDoc(doc(db,"users",currentUser.uid),{ Foto: url });
      document.getElementById("fotoUsuario").src = url;
      alert("Foto actualizada correctamente");
      document.getElementById("nuevaFoto").value="";
    }catch(err){
      console.error(err);
      alert("Error al actualizar la foto");
    }
  });

</script>

</body>
</html>
