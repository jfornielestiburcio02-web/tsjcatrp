<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CAU - Centro Atención Usuarios</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
    background:#f0f2f5;
    padding:20px;
  }

  h2 { text-align:center; color:#333; }
  .buttons { display:flex; gap:10px; justify-content:center; margin-bottom:20px; }
  .buttons button {
    padding:8px 16px;
    border:none;
    border-radius:8px;
    background: linear-gradient(135deg,#1e90ff,#0077cc);
    color:white;
    cursor:pointer;
    font-weight:600;
  }
  .buttons button:hover { background: linear-gradient(135deg,#0077cc,#005fa3); }

  .card {
    background:white;
    border-radius:12px;
    padding:20px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    margin-bottom:20px;
  }

  input, select, textarea {
    width:100%;
    padding:8px;
    margin-top:5px;
    margin-bottom:10px;
    border-radius:6px;
    border:1px solid #ccc;
  }

  .log { max-height:400px; overflow-y:auto; background:#eef; padding:10px; border-radius:6px; }
  .log-entry { border-bottom:1px solid #ccc; padding:6px 0; }
  .log-entry:last-child { border-bottom:none; }
  .respuesta { margin-top:5px; font-style:italic; color:#555; }
</style>
</head>
<body>

<h2>CAU - Centro Atención Usuarios</h2>

<div class="buttons">
  <button id="btnNuevo">Nuevo</button>
  <button id="btnRegistro">Registros</button>
</div>

<div id="nuevo" style="display:none;" class="card">
  <h3>Crear nueva incidencia</h3>
  <label for="tipo">Tipo de incidencia</label>
  <input type="text" id="tipo" placeholder="Ej: Consulta, Problema técnico...">

  <label for="motivo">Motivo</label>
  <textarea id="motivo" rows="3" placeholder="Describe tu incidencia"></textarea>

  <button id="guardarIncidencia">Guardar Incidencia</button>
</div>

<div id="registro" style="display:none;" class="card">
  <h3>Registros de incidencias</h3>
  <div class="log" id="logCau"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBPr8ZmxwYLyH1j8EygyMH78_4fAyu0xFo",
  authDomain: "tsjcatrp.firebaseapp.com",
  projectId: "tsjcatrp",
  storageBucket: "tsjcatrp.firebasestorage.app",
  messagingSenderId: "858193188422",
  appId: "1:858193188422:web:3b5118e1022a44faad9c47",
  measurementId: "G-T3ZV6LKBVV"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

const btnNuevo = document.getElementById("btnNuevo");
const btnRegistro = document.getElementById("btnRegistro");
const nuevoDiv = document.getElementById("nuevo");
const registroDiv = document.getElementById("registro");
const logCau = document.getElementById("logCau");

const tipoInput = document.getElementById("tipo");
const motivoInput = document.getElementById("motivo");
const guardarBtn = document.getElementById("guardarIncidencia");

// Alternar vistas
btnNuevo.addEventListener("click", ()=>{
  nuevoDiv.style.display="block";
  registroDiv.style.display="none";
});
btnRegistro.addEventListener("click", ()=>{
  nuevoDiv.style.display="none";
  registroDiv.style.display="block";
});

// Detectar usuario logueado
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    window.top.location.href="/modulo_acceso/identificacion.jsp";
    return;
  }
  currentUser = user;
  cargarRegistros();
});

// Guardar incidencia
guardarBtn.addEventListener("click", async ()=>{
  const tipo = tipoInput.value.trim();
  const motivo = motivoInput.value.trim();

  if(!tipo || !motivo){
    alert("Todos los campos son obligatorios");
    return;
  }

  try {
    await addDoc(collection(db,"cau"),{
      uid: currentUser.uid,
      tipo,
      motivo,
      respuesta: "", // inicial vacía
      createdAt: new Date()
    });

    tipoInput.value="";
    motivoInput.value="";
    cargarRegistros();
    alert("Incidencia registrada correctamente ✅");
  } catch(err){
    console.error(err);
    alert("Error al guardar incidencia");
  }
});

// Cargar registros del usuario
async function cargarRegistros(){
  logCau.innerHTML="<h4>Mis Incidencias</h4>";
  try {
    const q = query(
      collection(db,"cau"),
      where("uid","==",currentUser.uid),
      orderBy("createdAt","desc")
    );

    const snapshot = await getDocs(q);
    if(snapshot.empty){
      logCau.innerHTML += "<p>No tienes incidencias aún.</p>";
      return;
    }

    snapshot.forEach(docu=>{
      const data = docu.data();
      // Convertir createdAt seguro
      let fecha = new Date();
      if(data.createdAt){
        if(data.createdAt.toDate) fecha = data.createdAt.toDate();
        else if(data.createdAt.seconds) fecha = new Date(data.createdAt.seconds*1000);
        else fecha = new Date(data.createdAt);
      }

      const entry = document.createElement("div");
      entry.className="log-entry";
      entry.innerHTML = `<strong>Tipo:</strong> ${data.tipo}<br>
                         <strong>Motivo:</strong> ${data.motivo}<br>
                         <strong>Respuesta:</strong> <span class="respuesta">${data.respuesta || "(sin respuesta aún)"}</span><br>
                         <em>Creado: ${fecha.toLocaleString()}</em>`;
      logCau.appendChild(entry);
    });
  } catch(err){
    console.error(err);
    logCau.innerHTML += "<p>Error cargando registros.</p>";
  }
}
</script>
<script type="module" src="protectorEntradas.js"></script>
<script type="module">
  protegerRuta(["TSJ Dirección"]);
</script>


</body>
</html>
